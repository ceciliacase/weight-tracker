<html>
<head>
<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.css">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/tabletools/2.2.4/js/dataTables.tableTools.min.js"></script>

<style>
  .highlight {color:red;}
</style>
</head>

<body>
This the static stuff up front<br>
And there's nav<br>

<h2>Enter your weight:</h2>
Date:
<input type='date' id='newDate' value={{currentdate}}>
Weight:
<input type='number' id='newWeight' value={{latestweight.0}}>
<button id='addWeightButton' value='Add Weight'>Add</button>


<h2>Here's the data:</h2>
<!--TODO: Design the state for when the table is empty-->
<table id='weighttable' class="display" cellspacing="0" width="400px">
  <thead>
  <tr>
    <th>id</th>
    <th>Date</th>
    <th>DateSub</th></th>
    <th>Weight</th>
    <th>buttons</th>
  </tr>
  </thead>
</table>

<br>
And the chart here

Footer
<script>
// Fill the initial table with the weight information
$.ajax({url:'/weights',
  type:'GET',
  dataType:'json',
  success: function (resultdata) {
    var weights = resultdata.weights;
    // alert(JSON.stringify(weights));
    // Add DataTable
    $('#weighttable').DataTable({
      data: weights,
      "paging":   false,
      // "ordering": false,
      "info":     false,
      "order": [ 1, "desc" ],
      "columnDefs": [{
        "targets": [0],
        "visible": false,
        "searchable": false
      },{
        "targets": [2],
        "visible": false,
        "searchable": false
      },{
        "targets": -1,
        "data": null,
        "defaultContent": "<button class='editRowButton'>Edit</button><button class='deleteRowButton'>Delete</button>"
      }]
    });    
  }
});

// Add or update a weight to the table
$('#addWeightButton').click(function(){
  var table = $('#weighttable').DataTable();
  $.ajax({url:'/weights',
    type:'POST',
    dataType: 'json',
    success: function( resultdata ) {
      // Check if the row already exists
      // alert(resultdata.result[1]);
      var matchingValue = $('td').filter(function(index){
        return $(this).text()===resultdata.result[1];
      });
      // TODO: Add an animation to the edited row to draw the eye
      matchingValue.parent().addClass("highlight");
      if(matchingValue.length){
        // console.log('matchingValue exists');
        table.row(matchingValue.parent())
          .data([resultdata.result[0],resultdata.result[1],resultdata.result[2],resultdata.result[3]])
          .draw();
      } else {
        table.row.add([resultdata.result[0],resultdata.result[1],resultdata.result[2],resultdata.result[3]])
          .draw().node();
        // console.log('matchingValue does not exist');
      }
    },
    data: {
      // Pass the data to add the row on the server
      addrow: 'yes',
      weight: $('#newWeight').val(),
      date: $('#newDate').val() 
    }
   });
});

// Delete a weight from the table
$('body').on('click', '.deleteRowButton', (function() {
  var table = $('#weighttable').DataTable();
  var thisRow = $(this).parents('tr');
  var thisRowId = table.cell(thisRow, 0).data();
  $.ajax({url:'/weights',
    type:'POST',
    dataType: 'json',
    success: function(result) {
      // Delete the row on the client
      table.row(thisRow).remove().draw();
    },
    data: {
      // Pass the row id to delete on the server
      deleterow: thisRowId
    }
  });
}));

// Insert edit fields into the row to be edited
$('body').on('click', '.editRowButton',(function() {
  console.log('edit!');
  var thisRow = $(this).parent().parent();
  // Replace text with form fields
  thisRow.replaceWith(function(){
    var fillData = [
      thisRow.children(".id").html(),
      thisRow.children(".date").html(),
      thisRow.children(".dateSubmitted").html(),
      thisRow.children(".weight").html()];
/* 			alert(fillData); */
    return "<tr rowid='" + fillData[0] + "' class='weightrow'><td class='id' origVal='" + fillData[0] + "'>"
      + fillData[0] + "</td><td class='date' origVal='" + fillData[1] + "'><input type='date' id='editDate' value='"
      + fillData[1] + "'></td><td class='dateSubmitted' origVal='" + fillData[2] + "'>"
      + fillData[2] + "</td><td class='weight' origVal='" + fillData[3] + "'><input type='number' id='editWeight' value='"
      + fillData[3] + "'></td><td><button class='cancelEditRowButton'>Cancel</button>"
		  + "<button class='saveRowButton'>Save</button></td></tr>";
  });
}));

// Save the edited fields
$('body').on('click','.saveRowButton',(function(){
/*     alert('1'); */
	var thisRow = $(this).parent().parent();

	var newData = [
		thisRow.children(".id").html(),
		thisRow.children().children("#editDate").val(),
		thisRow.children().children("#editWeight").val()];
/* 		alert(newData); */
	// Send the new data to the server
	$.ajax({url:'/weights',
 		type:'POST',
 		dataType: 'json',
		success: function(resultdata) {
			// Edit the row on the client
			thisRow.replaceWith(function() {
				return "<tr rowid='" + resultdata.result[0] + "' class='weightrow'><td class='id'>"
						+ resultdata.result[0] + "</td><td class='date'>"
						+ resultdata.result[1] + "</td><td class='dateSubmitted'>"
						+ resultdata.result[2] + "</td><td class='weight'>"
						+ resultdata.result[3] + "</td><td class='buttons'><button class='deleteRowButton'>Delete</button>"
						+ "<button class='editRowButton'>Edit</button></td></tr>";
			});
		},
 		data: {
			// Pass the data and rowid to update the record on the server
			editrow: newData[0],
			date: newData[1],
			weight: newData[2]
		}
  });
	
}));

// Cancel the edit fields and return to the original values
$('body').on('click', '.cancelEditRowButton',(function() {
  var thisRow = $(this).parent().parent();

  // Replace form fields with text
  thisRow.replaceWith(function(){
    var fillData = [
      thisRow.children(".id").attr("origVal"),
      thisRow.children(".date").attr("origVal"),
      thisRow.children(".dateSubmitted").attr("origVal"),
      thisRow.children(".weight").attr("origVal")];
    return "<tr rowid='" + fillData[0] + "' class='weightrow'><td class='id'>"
        + fillData[0] + "</td><td class='date'>"
        + fillData[1] + "</td><td class='dateSubmitted'>"
        + fillData[2] + "</td><td class='weight'>"
        + fillData[3] + "</td><td class='buttons'><button class='deleteRowButton'>Delete</button>"
			  + "<button class='editRowButton'>Edit</button></td></tr>";
  });
}));


</script>
</body>
</html>