<!doctype html>
<html>
<head>
<!--TODO: Create title-->
<title>Title goes here</title>

<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.css">
<link rel="stylesheet" type="text/css" href="{{url_for('static',filename='css/style.css')}}">
<link rel="stylesheet" type="text/css" href="{{url_for('static',filename='css/dropzone.css')}}">
<link rel="stylesheet" type="text/css" href="{{url_for('static',filename='css/inline-edit.css')}}">
<link rel="stylesheet" type="text/css" href="{{url_for('static',filename='css/d3.css')}}">

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/tabletools/2.2.4/js/dataTables.tableTools.min.js"></script>
<script src="{{url_for('static',filename='js/dropzone.js')}}"></script>
<script src="{{url_for('static',filename='js/weightchart.js')}}"></script>

</head>

<body>
<header>
NEW HEADER
</header>
<nav>
  NAVIGATION
</nav>

<section id="main">
  <section id="weightchart">
    <svg id="visualisation" width="1000" height="500"></svg>
  </section>
  
  <section id="sidebar">
    <section id="addweight">
      <h2>Add your weight:</h2>
      Date:
      <input type='date' id='newDate' value={{currentdate}}>
      Weight:
      <input type='number' id='newWeight' value={{latestweight.0}}>
      <button id='addWeightButton' value='Add Weight'>Add</button>
    </section>

    <section id="weightlist">
      <table id='weighttable' class="display">
        <thead>
        <tr>
          <th></th>
          <th>Date</th>
          <th></th></th>
          <th>Weight</th>
          <th></th>
        </tr>
        </thead>
      </table>
    </section>
    <section id="uploadform">
      <form action="/upload" class="dropzone"></form>
    </section>
  </section>
</section>
<script>

// When an input field has focus, make the save button appear
// TODO: Make sure last value is put back in the field if they cancel out of the field
$('body').on('focus', 'tr', function(){
    $(this).children(":last").children(".saveRowButton").css('visibility','visible');
  }).on('blur', 'tr', function(){
    $(this).children(":last").children(".saveRowButton").css('visibility','hidden');
  });

// Submit an excel file
$('#fileForm').submit(function() {
  var data = new FormData(this); // <-- 'this' is your form element
  $.ajax({
    url: '/upload',
    type: 'POST',
    data: data,
    cache: false,
    contentType: false,
    processData: false,
    type: 'POST',     
    success: function(resultdata){
      var weights = resultdata.weights;
      // Redraw the table
      // TODO: Fix this
      addweightchart(weights);
    }
  });
});

// Fill the initial table with the weight information
$.ajax({url:'/weights',
  type:'GET',
  dataType:'json',
  success: function (resultdata) {
    var weights = resultdata.weights;
    // console.log(JSON.stringify(weights));
    // Add DataTable
    addweightchart(weights);

    // Create a weight array sorted by date, calculate and add smoothed weight and chart it
    var calcedweighttable = cleanweighttable(weights);
    console.log(calcedweighttable[1]);
    initChart(calcedweighttable);
  }
});

// Add or update a weight to the table
$('#addWeightButton').click(function(){
  var table = $('#weighttable').DataTable();
  $.ajax({url:'/weights',
    type:'POST',
    dataType: 'json',
    success: function( resultdata ) {
      // Check if the row already exists
      // console.log(resultdata.result[1]);
      var matchingValue = $('td').filter(function(index){
        return $(this).children().val()===resultdata.result[1];
      });
      // TODO: Add an animation to the edited row to draw the eye
      matchingValue.parent().addClass("highlight");
      if(matchingValue.length){
        // console.log('matchingValue exists');
        table.row(matchingValue.parent())
          .data([resultdata.result[0],resultdata.result[1],resultdata.result[2],resultdata.result[3]])
          .draw();
      } else {
        table.row.add([resultdata.result[0],resultdata.result[1],resultdata.result[2],resultdata.result[3]])
          .draw().node();
        // console.log('matchingValue does not exist');
      }
    },
    data: {
      // Pass the data to add the row on the server
      addrow: 'yes',
      weight: $('#newWeight').val(),
      date: $('#newDate').val() 
    }
   });
});

// Delete a weight from the table
$('body').on('click', '.deleteRowButton', (function() {
  var table = $('#weighttable').DataTable();
  var thisRow = $(this).parents('tr');
  var thisRowId = table.cell(thisRow, 0).data();
  $.ajax({url:'/weights',
    type:'POST',
    dataType: 'json',
    success: function(result) {
      // Delete the row on the client
      table.row(thisRow).remove().draw();
    },
    data: {
      // Pass the row id to delete on the server
      deleterow: thisRowId
    }
  });
}));

// Save the edited fields
$('body').on('click','.saveRowButton',(function(){
  var table = $('#weighttable').DataTable();
  var thisRow = $(this).parents('tr');
  var thisRowId = table.cell(thisRow, 0).data();
  // console.log(thisRowId);
	var newData = [
		table.cell(thisRow, 0).data(),
		table.cell(thisRow, 1).data(),
		thisRow.children().children('.weight').val()];
  // console.log(newData);
	// Send the new data to the server
	$.ajax({url:'/weights',
 		type:'POST',
 		dataType: 'json',
		success: function(resultdata) {
		},
 		data: {
			// Pass the rowid and data to update the record on the server
			editrow: newData[0],
			date: newData[1],
			weight: newData[2]
		}
  });
	
}));

function addweightchart(weights) {
  $('#weighttable').DataTable({
    data: weights,
    "destroy": true,
    "paging":   false,
    "info":     false,
    "ordering": true,
    "order": [ 1, 'desc' ],
    "language": {
      "emptyTable": "You haven't started tracking your weight. Enter today's weigh-in above!"
    },
    "columnDefs": [{
      "targets": [0],
      "visible": false,
      "searchable": false
    },{
      "targets": [2],
      "visible": false,
      "searchable": false
    },{
      "targets":[3],
      "render": function (data, type, row) {
        return "<input type='number' class='inline-edit weight' value='" + data + "'>";
      }
    },{
      "targets": -1,
      "data": null,
      "defaultContent": "<button class='saveRowButton'>Save</button><button class='deleteRowButton'>Delete</button>"
    }]
  });
}

function cleanweighttable(weights) {
  // Sort table by date
  function Comparator(a,b) {
    if (a[1] < b[1]) return -1;
    if (a[1] > b[1]) return 1;
    return 0;
  }
  weights = weights.sort(Comparator);
  // Add exponentially averaged weights column
  // [id],[date],[datesum],[weight]
  // expand all rows to have the correct amount of cols
  var cols = 5;
  for (var i = 0; i < weights.length; i++) {
    for (var j =  weights[i].length; j < cols; j++) {
      var currentweight=weights[i][3];
      var smoothedweight;
      var EXPRATE = 0.1;
      if (i==0) {
        // First datapoint needs to be equal to entered weight
        smoothedweight = currentweight;
      } else {
        var previoussmoothedweight=weights[i-1][4];
        // console.log(previoussmoothedweight);
        // console.log(currentweight);
        smoothedweight = previoussmoothedweight+(EXPRATE*(currentweight-previoussmoothedweight));
      }
      weights[i][4] = smoothedweight;
    }
  }
  console.log(weights[1]);
  return weights;
}


</script>
</body>
</html>